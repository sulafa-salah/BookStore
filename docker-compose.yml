services:
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: azurite
    command: "azurite -l /data --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0"
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    volumes:
      - azurite-data:/data
    networks: [bookstore-net]

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    environment:
      - SA_PASSWORD=${DB_SA_PASSWORD}
      - ACCEPT_EULA=Y
    ports:
      - "1434:1433"
    volumes:
      - sql-data:/var/opt/mssql
    networks: [bookstore-net]

  

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5673:5672"
      - "15673:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    networks: [bookstore-net]

  redis:
    image: redis:7
    container_name: redis
    ports: ["6379:6379"]
    volumes: [redis-data:/data]
    networks: [bookstore-net]

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports: ["8081:8081"]
    depends_on: [redis]
    networks: [bookstore-net]

  catalog-api:
    build:
      context: .
      dockerfile: Services/Catalog/src/Catalog.Api/Dockerfile
    container_name: catalog-api
    ports: ["7200:8080"]
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - JwtSettings__Secret=${JWT_SECRET}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=BookStore_Catalog;User=sa;Password=${DB_SA_PASSWORD};Encrypt=False;TrustServerCertificate=True
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Port=5672
      - AzureStorage__ConnectionString=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;
      - AzureStorage__CoversContainer=media
      - AzureStorage__ThumbsContainer=thumbs
      - InternalApi__Key=${INTERNAL_API_KEY}
    depends_on:
      - sqlserver
      - rabbitmq
      - azurite     
    networks: [bookstore-net]

  identity-api:
    build:
      context: .
      dockerfile: Services/Identity/src/Identity.Api/Dockerfile
    container_name: identity-api
    ports: ["7100:8080"]
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - JwtSettings__Secret=${JWT_SECRET}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=BookStore_Identity;User=sa;Password=${DB_SA_PASSWORD};Encrypt=False;TrustServerCertificate=True
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Port=5672
    depends_on:
      - sqlserver
      - rabbitmq
    networks: [bookstore-net]

  cart-api:
    build:
      context: .
      dockerfile: Services/Cart/src/Cart.Api/Dockerfile
    container_name: cart-api
    ports: ["7300:8080"]
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - JwtSettings__Secret=${JWT_SECRET}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
      - ConnectionStrings__Redis=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Port=5672
    depends_on:
      - redis
      - rabbitmq
    networks: [bookstore-net]

  gateway-api:
    build:
      context: .
      dockerfile: Services/Gateway/src/Gateway.Api/Dockerfile
    container_name: gateway-api
    ports: ["7000:8080"]
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - JwtSettings__Secret=${JWT_SECRET}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
    depends_on:
      - identity-api
      - catalog-api
      - cart-api
    networks: [bookstore-net]

  image-processor:
    build:
      context: .
      dockerfile: Functions/ImageProcessor/src/ImageProcessor.Functions/Dockerfile
    container_name: image-processor
    environment:
      - AzureWebJobsStorage=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1
      - CATALOG_BASE_URL=http://catalog-api:8080
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - MEDIA_CONTAINER=media
    depends_on: [azurite, catalog-api]
    networks: [bookstore-net]

networks:
  bookstore-net:
    name: bookstore-net

volumes:
  redis-data:
  sql-data:
  azurite-data:
